<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Collaborative Editor</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }
    .editor-container {
      max-width: 800px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      border-radius: 8px;
      min-height: 1120px; /* Close to A4 (297mm x 210mm) */
    }
    .toolbar {
      margin-bottom: 1rem;
    }
    #editor {
      width: 100%;
      height: 1000px;
      border: none;
      resize: none;
      outline: none;
      font-family: 'Arial', sans-serif;
      font-size: 16px;
      padding: 1rem;
      background: transparent;
    }
    .shape {
      position: absolute;
      border: 2px dashed #007bff;
      background: rgba(0, 123, 255, 0.1);
      pointer-events: none;
    }
    .cursor {
      pointer-events: none;
      z-index: 1000;
    }
  </style>
</head>

<body>

<div class="container">
  <div class="editor-container position-relative">

    <div class="toolbar d-flex flex-wrap gap-2 mb-3">
      <select id="fontSelect" class="form-select form-select-sm" style="width: auto;">
        <option value="Arial">Arial</option>
        <option value="Times New Roman">Times New Roman</option>
        <option value="Courier New">Courier New</option>
        <option value="Verdana">Verdana</option>
      </select>

      <input type="color" id="colorPicker" class="form-control form-control-color" title="Pick text color">

      <button id="boldBtn" class="btn btn-sm btn-outline-primary">Bold</button>
      <button id="italicBtn" class="btn btn-sm btn-outline-primary">Italic</button>
      <button id="underlineBtn" class="btn btn-sm btn-outline-primary">Underline</button>

      <button id="insertImageBtn" class="btn btn-sm btn-outline-success">Insert Image</button>

      <div class="dropdown">
        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
          Insert Shape
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="#" onclick="startDrawing('rectangle')">Rectangle</a></li>
          <li><a class="dropdown-item" href="#" onclick="startDrawing('circle')">Circle</a></li>
        </ul>
      </div>
    </div>

    <div id="drawingArea" class="position-relative" style="min-height:1000px;">
      <div contenteditable="true" id="editor"></div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const params = new URLSearchParams(window.location.search);
  const sessionId = params.get("session");
  const userId = params.get("user") || ("user-" + Math.floor(Math.random() * 10000));
  const username = params.get("username") || userId;
  const userColor = params.get("color") || "#000000";

  const socket = new WebSocket("ws://localhost:8080/edit?session=" + sessionId);
  const editor = document.getElementById("editor");
  let lastValue = "";
  let selfChange = false;

  fetch(`/content?session=${sessionId}`)
    .then(res => res.text())
    .then(text => {
      editor.innerHTML = text;
      lastValue = text;
    });

  editor.addEventListener("input", () => {
    if (selfChange) {
      selfChange = false;
      return;
    }

    const newValue = editor.innerHTML;
    socket.send(JSON.stringify({
      type: "update",
      userId,
      username,
      userColor,
      sessionId,
      content: newValue
    }));
    lastValue = newValue;
  });

  socket.addEventListener("message", (event) => {
    const data = JSON.parse(event.data);

    if (data.userId === userId) return;
    if (data.type === "update") {
      selfChange = true;
      editor.innerHTML = data.content;
      lastValue = data.content;
    }
  });

  // Toolbar actions
  document.getElementById("fontSelect").addEventListener("change", (e) => {
    document.execCommand('fontName', false, e.target.value);
  });

  document.getElementById("colorPicker").addEventListener("input", (e) => {
    document.execCommand('foreColor', false, e.target.value);
  });

  document.getElementById("boldBtn").addEventListener("click", () => {
    document.execCommand('bold');
  });

  document.getElementById("italicBtn").addEventListener("click", () => {
    document.execCommand('italic');
  });

  document.getElementById("underlineBtn").addEventListener("click", () => {
    document.execCommand('underline');
  });

  document.getElementById("insertImageBtn").addEventListener("click", () => {
    const url = prompt("Enter Image URL:");
    if (url) {
      document.execCommand('insertImage', false, url);
    }
  });

  // Drawing shapes
  let isDrawing = false;
  let shapeType = null;
  let shapeElement = null;
  const drawingArea = document.getElementById('drawingArea');

  function startDrawing(type) {
    shapeType = type;
    isDrawing = true;
  }

  drawingArea.addEventListener('mousedown', (e) => {
    if (!isDrawing) return;

    shapeElement = document.createElement('div');
    shapeElement.classList.add('shape');
    shapeElement.style.left = e.offsetX + 'px';
    shapeElement.style.top = e.offsetY + 'px';
    shapeElement.dataset.startX = e.offsetX;
    shapeElement.dataset.startY = e.offsetY;

    drawingArea.appendChild(shapeElement);

    drawingArea.addEventListener('mousemove', resizeShape);
    drawingArea.addEventListener('mouseup', finishShape);
  });

  function resizeShape(e) {
    if (!shapeElement) return;

    const startX = parseInt(shapeElement.dataset.startX);
    const startY = parseInt(shapeElement.dataset.startY);
    const width = e.offsetX - startX;
    const height = e.offsetY - startY;

    shapeElement.style.width = Math.abs(width) + 'px';
    shapeElement.style.height = Math.abs(height) + 'px';
    shapeElement.style.left = (width < 0 ? e.offsetX : startX) + 'px';
    shapeElement.style.top = (height < 0 ? e.offsetY : startY) + 'px';

    if (shapeType === 'circle') {
      shapeElement.style.borderRadius = '50%';
    } else {
      shapeElement.style.borderRadius = '0';
    }
  }

  function finishShape(e) {
    isDrawing = false;
    shapeType = null;
    shapeElement = null;
    drawingArea.removeEventListener('mousemove', resizeShape);
    drawingArea.removeEventListener('mouseup', finishShape);
  }
</script>

</body>
</html>
